import re
from gvtest.testsuite import Shell, Checker, Testset, Test

def check_value(value, expected, log):
    result = True

    error = (float(value) - expected) / expected * 100

    if abs(error) > 2:
        log += f'Got wrong power (value: {value}, expected: {expected}, error: {error} %)'
        result = False

    return (result, log)


def check_output(_test: Test, output: str):

    pattern = r'@power\.measure_(\d+)@([\d.]+)@'

    matches = re.findall(pattern, output)

    expected = [
        0.000101, 0.000151, 0.000351, 0.000434,
        0.000101, 0.000168, 0.000468, 0.000579,
        0.000101, 0.000201, 0.000701, 0.000868,
    ]

    log = ''
    for idx, value in matches:
        (result, log) = check_value(value, expected[int(idx)], log)
        if not result:
            return (result, log)

    return (True, None)

def testset_build(testset: Testset):

    test = testset.new_test('14_how_to_add_power_traces_to_a_component')
    test.add_command(Shell('clean', f'make clean BUILDDIR={test.get_path()}'))
    test.add_command(Shell('gvsoc', f'make prepare gvsoc BUILDDIR={test.get_path()}'))
    test.add_command(Shell('all', f'make all BUILDDIR={test.get_path()}'))
    test.add_command(Shell('run', f'make run runner_args=--power BUILDDIR={test.get_path()}'))
    test.add_command(Checker('check', check_output))
