from gvtest.testsuite import Shell, Checker, Testset, Test

def check_output(test, output):

    expected = 'Hello, got 0x12345678 from my comp\n'

    if output.find(expected) == -1:
        return (False, "Didn't find output string\n")

    expected = 'Received request at offset 0x0, size 0x4, is_write 0\n'

    if output.find(expected) == -1:
        return (False, "Didn't find output string\n")

    return (True, None)

def testset_build(testset: Testset):

    test = testset.new_test('3_how_to_add_system_traces_to_a_component')
    test.add_command(Shell('clean', f'make clean BUILDDIR={test.get_path()}'))
    test.add_command(Shell('gvsoc', f'make prepare gvsoc BUILDDIR={test.get_path()}'))
    test.add_command(Shell('all', f'make all BUILDDIR={test.get_path()}'))
    test.add_command(Shell('run', f'make run runner_args=--trace=my_comp BUILDDIR={test.get_path()}'))
    test.add_command(Checker('check', check_output))
